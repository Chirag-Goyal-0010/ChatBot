<div class="max-w-6xl mx-auto p-6">
  <% if flash[:notice] %>
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6 shadow">
      <%= flash[:notice] %>
    </div>
  <% end %>
  <% if flash[:alert] %>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6 shadow">
      <%= flash[:alert] %>
    </div>
  <% end %>

  <h1 class="text-3xl font-extrabold mb-8 text-center">Submitted Website URLs</h1>

  <div class="w-full overflow-x-auto rounded-lg shadow">
    <table class="w-full min-w-full bg-white border border-gray-300 text-sm table-fixed" style="table-layout:fixed;">
      <colgroup>
        <col style="width:45%">
        <col style="width:10%">
        <col style="width:45%">
      </colgroup>
      <thead class="bg-gray-100 border-b border-gray-300">
        <tr>
          <th class="py-2 px-3 text-left font-semibold text-gray-700 border-r border-gray-300">URL</th>
          <th class="py-2 px-3 text-left font-semibold text-gray-700 border-r border-gray-300">Status</th>
          <th class="py-2 px-3 text-left font-semibold text-gray-700">Chunks</th>
        </tr>
      </thead>
      <tbody>
        <% @websites.each do |website| %>
          <tr class="border-b border-gray-200 hover:bg-gray-50">
            <td class="py-2 px-3 align-top border-r border-gray-300 min-w-0 relative">
              <div data-controller="showmore" class="bg-gray-50 rounded p-2 url-cell w-full max-w-full" data-showmore-target="box">
                <div data-showmore-target="content" class="block w-full max-w-full overflow-x-auto whitespace-pre" style="max-height: 4.5em;">
                  <%= website.url %>
                </div>
                <% if website.url.length > 100 %>
                  <div class="w-full mt-1">
                    <button data-action="click->showmore#toggle" class="text-xs text-blue-600 bg-white px-1 rounded shadow">Show more</button>
                  </div>
                <% end %>
              </div>
            </td>
            <td class="py-2 px-3 align-top border-r border-gray-300 min-w-0">
              <% if website.status == 'active' %>
                <span class="inline-block px-2 py-1 text-xs font-semibold bg-green-200 text-green-800 rounded">Active</span>
              <% else %>
                <span class="inline-block px-2 py-1 text-xs font-semibold bg-gray-200 text-gray-800 rounded"><%= website.status %></span>
              <% end %>
            </td>
            <td class="py-2 px-3 align-top min-w-0 relative">
              <% if website.website_chunks.any? %>
                <div class="space-y-2 max-h-48 overflow-y-auto pr-1">
                  <% website.website_chunks.each do |chunk| %>
                    <div class="bg-gray-50 border border-gray-200 rounded p-2 mb-1 chunk-cell w-full max-w-full" data-controller="showmore">
                      <% if chunk.section.present? %>
                        <div class="font-semibold text-gray-700 mb-1"><%= chunk.section %></div>
                      <% end %>
                      <div data-showmore-target="content" class="block w-full max-w-full overflow-x-auto whitespace-pre" style="max-height: 6em;">
                        <%= chunk.content %>
                      </div>
                      <% if chunk.content.length > 200 %>
                        <div class="w-full mt-1">
                          <button data-action="click->showmore#toggle" class="text-xs text-blue-600 bg-white px-1 rounded shadow">Show more</button>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <span class="italic text-gray-400">No chunks</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="flex justify-center mt-8">
    <%= form_with url: ask_website_path, method: :post, local: true, class: "w-full max-w-xl" do |f| %>
      <div class="flex items-center space-x-2">
        <%= f.text_field :question, placeholder: "Ask a question...", class: "flex-1 px-3 py-2 border rounded shadow" %>
        <%= f.submit "Ask", class: "bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded shadow" %>
      </div>
    <% end %>
  </div>

  <!-- AI Results Section -->
  <% if params[:question].present? %>
    <div class="mt-8 max-w-4xl mx-auto">
      <h2 class="text-2xl font-bold mb-4 text-center">AI Answer</h2>
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
        <% if @chunks && @chunks.any? %>
          <h3 class="text-lg font-semibold mb-3">Relevant Information:</h3>
          <div class="space-y-4">
            <% @chunks.each do |chunk| %>
              <div class="bg-white border border-gray-300 rounded p-4">
                <% if chunk.section.present? %>
                  <div class="font-semibold text-gray-700 mb-2"><%= chunk.section %></div>
                <% end %>
                <div class="text-gray-800"><%= chunk.content %></div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-600 text-center">I don't have information to answer that question.</p>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="flex justify-center mt-8">
    <%= link_to 'Submit Another URL', new_website_path, class: "inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded shadow" %>
  </div>

  <div class="flex justify-center mt-4">
    <%= link_to 'ðŸ¤– AI Assistant', answer_website_path, method: :get, class: "inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded shadow" %>
  </div>
</div>
